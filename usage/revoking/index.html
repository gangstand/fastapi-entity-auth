
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="FastAPI extension that provides JWT Auth support (secure, easy to use, and lightweight)">
      
      
      
      
        <link rel="prev" href="../freshness/">
      
      
        <link rel="next" href="../jwt-in-cookies/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3">
    
    
      
        <title>Revoking Tokens - FastAPI Entity Auth</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="FastAPI Entity Auth" class="md-header__button md-logo" aria-label="FastAPI Entity Auth" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            FastAPI Entity Auth
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Revoking Tokens
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/gangstand/fastapi-entity-auth" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    gangstand/fastapi-entity-auth
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="FastAPI Entity Auth" class="md-nav__button md-logo" aria-label="FastAPI Entity Auth" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    FastAPI Entity Auth
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/gangstand/fastapi-entity-auth" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    gangstand/fastapi-entity-auth
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Usage
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Usage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Basic Usage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../optional/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Partially Protecting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../refresh/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Refresh Tokens
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../freshness/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Freshness Tokens
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Revoking Tokens
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../jwt-in-cookies/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    JWT in Cookies
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../additional-claims/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Additional claims
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../asymmetric/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Asymmetric Algorithm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dynamic-algorithm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dynamic Token Algorithm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../websocket/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    WebSocket Protecting
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Release Notes
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Revoking Tokens</h1>

<p>This will allow you to revoke a specific tokens so that it can no longer access your endpoints. You will have to choose
what tokens you want to check against the denylist. Denylist works by providing a callback function to this extension,
using the <strong>token_in_denylist_loader()</strong>. This method will be called whenever the specified tokens <em>(access and/or
refresh)</em> is used to access a protected endpoint. If the callback function says that the tokens is revoked, we will not
allow the requester to continue, otherwise we will allow the requester to access the endpoint as normal.</p>
<p>Here is a basic example use tokens revoking:</p>
<p><strong>Source Code</strong>: <a href="https://github.com/gangstand/fastapi-entity-auth/blob/main/examples/deny_list.py" target="_blank"><a href="https://github.com/gangstand/fastapi-entity-auth/blob/main/examples/deny_list.py">https://github.com/gangstand/fastapi-entity-auth/blob/main/examples/deny_list.py</a></a></p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">uvicorn</span>
<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="kn">from</span> <span class="nn">fastapi_entity_auth</span> <span class="kn">import</span> <span class="n">EntityAuth</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span>


<span class="c1"># set deny_list enabled to True</span>
<span class="c1"># you can set to check access or refresh token or even both of them</span>
<span class="k">class</span> <span class="nc">UtilsEntityAuth</span><span class="p">(</span><span class="n">EntityAuth</span><span class="p">):</span>
    <span class="n">secret_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;secret&quot;</span>
    <span class="n">deny_list_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">deny_list_token_checks</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;access&quot;</span><span class="p">,</span> <span class="s2">&quot;refresh&quot;</span><span class="p">}</span>


<span class="n">instance_auth</span> <span class="o">=</span> <span class="n">UtilsEntityAuth</span>

<span class="c1"># A storage engine to save revoked tokens. in production,</span>
<span class="c1"># you can use Redis for storage system</span>
<span class="n">deny_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>


<span class="c1"># For this example, we are just checking if the tokens jti</span>
<span class="c1"># (unique identifier) is in the deny_list set. This could</span>
<span class="c1"># be made more complex, for example storing the token in Redis</span>
<span class="c1"># with the value true if revoked and false if not revoked</span>
<span class="nd">@instance_auth</span><span class="o">.</span><span class="n">token_in_deny_list_loader</span>
<span class="k">def</span> <span class="nf">check_if_token_in_deny_list</span><span class="p">(</span><span class="n">decrypted_token</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">jti</span> <span class="o">=</span> <span class="n">decrypted_token</span><span class="p">[</span><span class="s2">&quot;jti&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">jti</span> <span class="ow">in</span> <span class="n">deny_list</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span> <span class="n">authorize</span><span class="p">:</span> <span class="n">instance_auth</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">username</span> <span class="o">!=</span> <span class="s2">&quot;string&quot;</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">password</span> <span class="o">!=</span> <span class="s2">&quot;string&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Bad username or password&quot;</span><span class="p">)</span>

    <span class="n">access_token</span> <span class="o">=</span> <span class="n">authorize</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">authorize</span><span class="o">.</span><span class="n">create_refresh_token</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span> <span class="s2">&quot;refresh_token&quot;</span><span class="p">:</span> <span class="n">refresh_token</span><span class="p">}</span>


<span class="c1"># Standard refresh endpoint. Token in deny_list will not</span>
<span class="c1"># be able to access this endpoint</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/refresh&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="n">authorize</span><span class="p">:</span> <span class="n">instance_auth</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">authorize</span><span class="o">.</span><span class="n">jwt_refresh_token_required</span><span class="p">()</span>

    <span class="n">current_user</span> <span class="o">=</span> <span class="n">authorize</span><span class="o">.</span><span class="n">get_jwt_subject</span><span class="p">()</span>
    <span class="n">new_access_token</span> <span class="o">=</span> <span class="n">authorize</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">current_user</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">new_access_token</span><span class="p">}</span>


<span class="c1"># Endpoint for revoking the current users access token</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;/access-revoke&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">access_revoke</span><span class="p">(</span><span class="n">authorize</span><span class="p">:</span> <span class="n">instance_auth</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">authorize</span><span class="o">.</span><span class="n">jwt_required</span><span class="p">()</span>

    <span class="n">jti</span> <span class="o">=</span> <span class="n">authorize</span><span class="o">.</span><span class="n">get_raw_jwt</span><span class="p">()[</span><span class="s2">&quot;jti&quot;</span><span class="p">]</span>
    <span class="n">deny_list</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">jti</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Access token has been revoke&quot;</span><span class="p">}</span>


<span class="c1"># Endpoint for revoking the current users refresh token</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;/refresh-revoke&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">refresh_revoke</span><span class="p">(</span><span class="n">authorize</span><span class="p">:</span> <span class="n">instance_auth</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">authorize</span><span class="o">.</span><span class="n">jwt_refresh_token_required</span><span class="p">()</span>

    <span class="n">jti</span> <span class="o">=</span> <span class="n">authorize</span><span class="o">.</span><span class="n">get_raw_jwt</span><span class="p">()[</span><span class="s2">&quot;jti&quot;</span><span class="p">]</span>
    <span class="n">deny_list</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">jti</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Refresh token has been revoke&quot;</span><span class="p">}</span>


<span class="c1"># A token in deny_list will not be able to access this any more</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/protected&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">protected</span><span class="p">(</span><span class="n">authorize</span><span class="p">:</span> <span class="n">instance_auth</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">authorize</span><span class="o">.</span><span class="n">jwt_required</span><span class="p">()</span>

    <span class="n">current_user</span> <span class="o">=</span> <span class="n">authorize</span><span class="o">.</span><span class="n">get_jwt_subject</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="p">}</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span>
</code></pre></div>
<strong>Running the Server</strong></p>
<p>To run the server, execute the following command:
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>python<span class="w"> </span>examples/deny_list.py
</code></pre></div>
This will start the FastAPI server on <a href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a>.</p>
<p>In production, you will likely want to use either a database or in-memory store (such as Redis) to store your tokens.
Memory stores are great if you are wanting to revoke a tokens when the users log out and you can define timeout to your
tokens in Redis, after the timeout has expired, the tokens will automatically be deleted.</p>
<p>Here example use Redis for revoking a tokens:</p>
<p><strong>Source Code</strong>: <a href="https://github.com/gangstand/fastapi-entity-auth/blob/main/examples/deny_list_redis.py" target="_blank"><a href="https://github.com/gangstand/fastapi-entity-auth/blob/main/examples/deny_list_redis.py">https://github.com/gangstand/fastapi-entity-auth/blob/main/examples/deny_list_redis.py</a></a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Before that make sure redis already installed on your local machine,
you can use docker using this command <code>docker run -d -p 6379:6379 redis</code></p>
</div>
<p><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

<span class="kn">import</span> <span class="nn">uvicorn</span>
<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="nn">redis</span> <span class="kn">import</span> <span class="n">Redis</span>

<span class="kn">from</span> <span class="nn">fastapi_entity_auth</span> <span class="kn">import</span> <span class="n">EntityAuth</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span>


<span class="c1"># set deny_list enabled to True</span>
<span class="c1"># you can set to check access or refresh token or even both of them</span>
<span class="k">class</span> <span class="nc">UtilsEntityAuth</span><span class="p">(</span><span class="n">EntityAuth</span><span class="p">):</span>
    <span class="n">secret_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;secret&quot;</span>
    <span class="n">deny_list_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">deny_list_token_checks</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;access&quot;</span><span class="p">,</span> <span class="s2">&quot;refresh&quot;</span><span class="p">}</span>
    <span class="n">access_token_expires</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">timedelta</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">refresh_token_expires</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">timedelta</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>


<span class="n">instance_auth</span> <span class="o">=</span> <span class="n">UtilsEntityAuth</span>

<span class="c1"># Setup our redis connection for storing the denylist tokens</span>
<span class="n">redis_conn</span> <span class="o">=</span> <span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1"># Create our function to check if a token has been revoked. In this simple</span>
<span class="c1"># case, we will just store the tokens jti (unique identifier) in redis.</span>
<span class="c1"># This function will return the revoked status of a token. If a token exists</span>
<span class="c1"># in redis and value is true, token has been revoked</span>
<span class="nd">@instance_auth</span><span class="o">.</span><span class="n">token_in_deny_list_loader</span>
<span class="k">def</span> <span class="nf">check_if_token_in_deny_list</span><span class="p">(</span><span class="n">decrypted_token</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">jti</span> <span class="o">=</span> <span class="n">decrypted_token</span><span class="p">[</span><span class="s2">&quot;jti&quot;</span><span class="p">]</span>
    <span class="n">entry</span> <span class="o">=</span> <span class="n">redis_conn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">jti</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">entry</span> <span class="ow">and</span> <span class="n">entry</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span> <span class="n">authorize</span><span class="p">:</span> <span class="n">instance_auth</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">username</span> <span class="o">!=</span> <span class="s2">&quot;string&quot;</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">password</span> <span class="o">!=</span> <span class="s2">&quot;string&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Bad username or password&quot;</span><span class="p">)</span>

    <span class="n">access_token</span> <span class="o">=</span> <span class="n">authorize</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">authorize</span><span class="o">.</span><span class="n">create_refresh_token</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span> <span class="s2">&quot;refresh_token&quot;</span><span class="p">:</span> <span class="n">refresh_token</span><span class="p">}</span>


<span class="c1"># Standard refresh endpoint. Token in deny_list will not</span>
<span class="c1"># be able to access this endpoint</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/refresh&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="n">authorize</span><span class="p">:</span> <span class="n">instance_auth</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">authorize</span><span class="o">.</span><span class="n">jwt_refresh_token_required</span><span class="p">()</span>

    <span class="n">current_user</span> <span class="o">=</span> <span class="n">authorize</span><span class="o">.</span><span class="n">get_jwt_subject</span><span class="p">()</span>
    <span class="n">new_access_token</span> <span class="o">=</span> <span class="n">authorize</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">current_user</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">new_access_token</span><span class="p">}</span>


<span class="c1"># Endpoint for revoking the current users access token</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;/access-revoke&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">access_revoke</span><span class="p">(</span><span class="n">authorize</span><span class="p">:</span> <span class="n">instance_auth</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">authorize</span><span class="o">.</span><span class="n">jwt_required</span><span class="p">()</span>

    <span class="n">jti</span> <span class="o">=</span> <span class="n">authorize</span><span class="o">.</span><span class="n">get_raw_jwt</span><span class="p">()[</span><span class="s2">&quot;jti&quot;</span><span class="p">]</span>
    <span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">jti</span><span class="p">,</span> <span class="n">instance_auth</span><span class="o">.</span><span class="n">access_token_expires</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Access token has been revoke&quot;</span><span class="p">}</span>


<span class="c1"># Endpoint for revoking the current users refresh token</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;/refresh-revoke&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">refresh_revoke</span><span class="p">(</span><span class="n">authorize</span><span class="p">:</span> <span class="n">instance_auth</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">authorize</span><span class="o">.</span><span class="n">jwt_refresh_token_required</span><span class="p">()</span>

    <span class="n">jti</span> <span class="o">=</span> <span class="n">authorize</span><span class="o">.</span><span class="n">get_raw_jwt</span><span class="p">()[</span><span class="s2">&quot;jti&quot;</span><span class="p">]</span>
    <span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">jti</span><span class="p">,</span> <span class="n">instance_auth</span><span class="o">.</span><span class="n">refresh_token_expires</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Refresh token has been revoke&quot;</span><span class="p">}</span>


<span class="c1"># A token in deny_list will not be able to access this any more</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/protected&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">protected</span><span class="p">(</span><span class="n">authorize</span><span class="p">:</span> <span class="n">instance_auth</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">authorize</span><span class="o">.</span><span class="n">jwt_required</span><span class="p">()</span>

    <span class="n">current_user</span> <span class="o">=</span> <span class="n">authorize</span><span class="o">.</span><span class="n">get_jwt_subject</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="p">}</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span>
</code></pre></div>
<strong>Running the Server</strong></p>
<p>To run the server, execute the following command:
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>python<span class="w"> </span>examples/deny_list_redis.py
</code></pre></div>
This will start the FastAPI server on <a href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a>.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
    
  </body>
</html>